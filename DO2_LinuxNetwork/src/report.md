## Part 1. Инструмент ipcalc

### 1.1. Сети и маски

1. Определение адреса сети  IP 192.167.38.54/13 .

- Использую команду: ```ipcalc -b 192.167.38.54/13```, нашли адрес сети 192.160.0.0 .

![](screenshots/1_1.png)

2. Перевод маски 255.255.255.0 в префиксную и двоичную запись, /15 в обычную и двоичную, 11111111.11111111.11111111.11110000 в обычную и префиксную .

- Используя команду: ```ipcalc 192.167.38.54/255.255.255.0``` найду запись маски 255.255.255.0 в префиксной и двоичной записи .

![](screenshots/1_2.png)

- Используя команду: ```ipcalc 192.167.38.54/15``` найду запись маски /15 в префиксной и двоичной записи .

![](screenshots/1_3.png)

- ipcalc не может переводить из двоичной системы в другую, поэтому мы можем перевести число 11111111.11111111.11111111.11110000 в префиксную запись. Т.к. там 28 единиц то в префиксной записи будет /28

- Используя команду: ```ipcalc 192.167.38.54/28``` найду запись маски /28 в обычной записи .

![](screenshots/1_4.png)

3. Минимальный и максимальный хост в сети 12.167.38.4 при масках: /8, 11111111.11111111.00000000.00000000, 255.255.254.0 и /4 .

- Используя маску /8 получил минимальный хост 12.0.0.1 и максимальный 12.255.255.254

![](screenshots/1_5.png)

- Используя маску 11111111.11111111.00000000.00000000 перевел ее в префиксную запись /16 и получил минимальный хост 12.167.0.1 и максимальный 12.167.255.254

![](screenshots/1_6.png)

- Используя маску 255.255.254.0 получил минимальный хост 12.167.38.1 и максимальный 12.167.39.254

![](screenshots/1_7.png)

- Используя маску /4 получил минимальный хост 0.0.0.1 и максимальный 15.255.255.254

![](screenshots/1_8.png)

### 1.2. localhost

- localhost в компьютерных сетях, стандартное, официально зарезервированное доменное имя для частных IP-адресов (в диапазоне 127.0.0.1 — 127.255.255.254).

- Получается что обратиться к приложению работающему на 127.0.0.2, 127.1.0.1 мы можем, а на 194.34.23.100, 128.0.0.1 нельзя, потому что это адреса внешней сети.

### 1.3. Диапазоны и сегменты сетей

1. К частным адресам относятся IP-адреса, значения которых лежат в следующих диапазонах:
- 10.0.0.0 – 10.255.255.255
- 172.16.0.0 – 172.31.255.255
- 192.168.0.0 – 192.168.255.255
- Это зарезервированные для локальных сетей IP-адреса.

- Использовать в качестве публичного мы можем : 134.43.0.2, 172.0.2.1, 192.172.0.1,  172.68.0.2, 192.169.168.1 .

- Использовать в качестве частных мы можем : 10.0.0.45, 192.168.4.2, 172.20.250.4, 172.16.255.255, 10.10.10.10 .

2.Возможные IP адреса шлюза у сети 10.10.0.0/18 в диапазоне 10.10.0.1 - 10.10.63.254 : 10.10.0.2, 10.10.10.10, 10.10.1.255

![](screenshots/1_9.png)

## Part 2. Статическая маршрутизация между двумя машинами

- С помощью команды ip a посмотреть существующие сетевые интерфейсы

![](screenshots/2_1.png)

 - Описать сетевой интерфейс, соответствующий внутренней сети, на обеих машинах и задать следующие адреса и маски: ws1 - 192.168.100.10, маска /16, ws2 - 172.24.116.8, маска /12

    - - На каждой машине мне доступно по 2 сетевых интерфейса, lo и enp0s3.

    - - lo - это сетевой интерфейс , который не подключен к сети и используется для того чтобы компьютер мог взаимодействовать сам с собой, чтобы я смог запустить свой сайт к примеру.

    - - enp0s3 -  это сетевой адаптер Ethernet, через которое устройство может взаимодействовать с другими устройствами в сети.

    - Для того чтобы настроить сеть между двумя виртуальными машинами, я добавлю еще один сетевой интерфейс для внутренней сети в каждой виртуально машине ws1 и ws2.

![](screenshots/2_2.png)

- Вызвав команду ip a видим что был добавлен новый адаптер сети enp0s8.

![](screenshots/2_3.png)

- Зададим статический адрес в etc/netplan/00-installer-config.yaml для нового сетевого интерфейса внутренней сети.

![](screenshots/2_4.png)


- Введем команду netplan apply для перезапуска сервиса сети.

![](screenshots/2_5.png)

### 2.1. Добавление статического маршрута вручную

- При помощи команды ip r add 172.24.116.8 dev enp0s8 мы создали маршрут от сетевого интерфейса ws1 до сетевого интерфейса ws2 по IP. И то же самое сделали от ws2 указав IP сетевого интерфейса ws1 192.168.100.10 .

![](screenshots/2_6.png)

- И затем пропинговали их между собой .

![](screenshots/2_7.png)

### 2.2. Добавление статического маршрута с сохранением

- Добавил статический маршрут от одной машины до другой с помощью файла etc/netplan/00-installer-config.yaml .

![](screenshots/2_8.png)

- Еще раз введем команду netplan apply для перезапуска сервиса сети.

![](screenshots/2_9.png)

- Пропингуем соединение между машинами .

![](screenshots/2_10.png)

## Part 3. Утилита iperf3

### 3.1. Скорость соединения

- Перевести и записать в отчёт: 8 Mbps в MB/s, 100 MB/s в Kbps, 1 Gbps в Mbps

- 8 Mbps = 1 MB/s
- 100 MB/s = 819200 Kbps
- 1 Gbps  = 1024 Mbps

### 3.2. Утилита iperf3

- Запустим команду sudo iperf3 -s на ws1, а на ws2 sudo iperf3 -c 192.168.100.10 для измерения скорости соединения.

![](screenshots/3_1.png)

## Part 4. Сетевой экран

### 4.1. Утилита iptables

- Создать файл /etc/firewall.sh, имитирующий фаерволл, на ws1 и ws2:

![](screenshots/4_1.png)

- Запустить файлы на обеих машинах командами chmod +x /etc/firewall.sh и /etc/firewall.sh

![](screenshots/4_2.png)

- Разницу между стратегиями, применёнными в первом и втором файлах заключается в том что в ws1 запрещающим правилом стоит DROP , разрешающим ACCEPT, а в ws2 все наоборот .

### 4.2. Утилита nmap

- Командой ping видим что ws2 не пингуется

![](screenshots/4_3.png)

- Утилитой nmap видно, что хост машины запущен

![](screenshots/4_4.png)

- Далее сохраним дампы ws1 и ws2 .

## Part 5. Статическая маршрутизация сети

- Создадим новые машины при момощи клонирования, чтобы не создавать новые при помощи образов.

![Alt text](screenshots/5_1.png)

- Так же для роутеров добавим дополнительный сетевой интерфейс внутренней сети как показано на рисунке.

- Появился новый адаптер enp0s9 у r1 и r2 при вызове команды ip a.

- r1

![Alt text](screenshots/5_2.png)

- r2

![Alt text](screenshots/5_3.png)

### 5.1. Настройка адресов машин

- Настроим конфигурацию и для этого добавим статический адрес для сетевого интерфейса для машин ws11, ws21, ws22 и для роутеров r1, r2 по схеме

- ws11

![Alt text](screenshots/5_4.png)

- r1

![Alt text](screenshots/5_5.png)

- r2

![Alt text](screenshots/5_6.png)

- ws22

![Alt text](screenshots/5_7.png)

- ws21

![Alt text](screenshots/5_8.png)

 - Перезапустим сервис на каждой машине и роутере при помощи команды sudo netplan apply, проверим адреса машин и роутеров при помощи команды ip -4 a, после этого пропингуем ws22 с ws21 и r1 с ws11.

- Вывод команд на ws11

![Alt text](screenshots/5_9.png)

- Вывод команд на r1

![Alt text](screenshots/5_10.png)

- Вывод команд на r2

![Alt text](screenshots/5_11.png)

- Вывод команд на ws22

![Alt text](screenshots/5_12.png)

- Вывод команд на ws21

![Alt text](screenshots/5_13.png)

### 5.2. Включение переадресации IP-адресов.

- Для включения переадресации IP, выполнить команду на роутерах r1 и r2

- r1

![Alt text](screenshots/5_14.png)

- r2

![Alt text](screenshots/5_15.png)

Открыл с помощью nano файл /etc/sysctl.conf на r1 и r2 и добавил в него следующую строку:

- r1

![Alt text](screenshots/5_16.png)

- r2

![Alt text](screenshots/5_17.png)

### 5.3. Установка маршрута по-умолчанию

- Для настроики маршрут по-умолчанию (шлюз) для рабочих станций для этого нужно добавить default перед IP роутера в файле конфигураций

- ws11

![Alt text](screenshots/5_18.png)

- ws22

![Alt text](screenshots/5_19.png)

- ws21

![Alt text](screenshots/5_20.png)

- Затем перезагружу сеть и вызову ip r и покажу, что добавился маршрут в таблицу маршрутизации

- ws11

![Alt text](screenshots/5_21.png)

- ws22

![Alt text](screenshots/5_22.png)

- ws21

![Alt text](screenshots/5_23.png)

- Пропингую с ws11 роутер r2 и покажу на r2, что пинг доходит. Для этого использую команду: tcpdump -tn -i enp0s8 в r1 и ping -c 5 10.100.0.12 в ws11. Видим что пинг до роутера доходит.

![Alt text](screenshots/5_24.png)

### 5.4. Добавление статических маршрутов

- Добавлю в роутеры r1 и r2 статические маршруты в файле конфигураций.

![Alt text](screenshots/5_25.png)

- Вызов ip r и вывод таблицы с маршрутами на обоих роутерах

![Alt text](screenshots/5_26.png)

- Запуск команды ip r list 10.10.0.0/[маска сети] и ip r list 0.0.0.0/0 на ws11 .

![Alt text](screenshots/5_27.png)

- Для адреса 10.10.0.0/[маска сети] был выбран маршрут, отличный от 0.0.0.0/0, потому что мы для 10.10.0.0 явно указали маршрут и будет выбран более точный, а если в таблице нет более точного маршрута то будет выбран маршрут по умолчанию.

### 5.5. Построение списка маршрутизаторов

- Запуск на r1 команды дампа:
tcpdump -tnv -i eth0

![Alt text](screenshots/5_28.png)

- При помощи утилиты traceroute построить список маршрутизаторов на пути от ws11 до ws21

![Alt text](screenshots/5_29.png)

- Команда traceroute использует UDP пакеты. Она отправляет пакет с TTL=1 и смотрит адрес ответившего узла, дальше TTL=2, TTL=3 и так пока не достигнет цели. Каждый раз отправляется по три пакета и для каждого из них измеряется время прохождения. Пакет отправляется на случайный порт, который, скорее всего, не занят. Когда утилита traceroute получает сообщение от целевого узла о том, что порт недоступен трассировка считается завершенной.

### 5.6. Использование протокола ICMP при маршрутизации

- Запущу на r1 перехват сетевого трафика, проходящего через enp0s8 с помощью команды tcpdump -n -i enp0s8 icmp

![Alt text](screenshots/5_30.png)

- Пропингую с ws11 несуществующий IP (например, 10.30.0.111) с помощью команды:
ping -c 1 10.30.0.111

![Alt text](screenshots/5_31.png)

- Сохраню дамп .

## Part 6. Динамическая настройка IP с помощью DHCP

- Для r2 настроить в файле /etc/dhcp/dhcpd.conf конфигурацию службы DHCP:

![Alt text](screenshots/6_1.png)

- В файле resolv.conf прописать nameserver 8.8.8.8.

![Alt text](screenshots/6_2.png)

- Перезагрузить службу DHCP командой systemctl restart isc-dhcp-server. 
![Alt text](screenshots/6_3.png)

- Машину ws21 перезагрузить при помощи reboot и через ip a показать, что она получила адрес.

![Alt text](screenshots/6_4.png)

- Также пропинговать ws22 с ws21.

![Alt text](screenshots/6_5.png)

- Указать MAC адрес у ws11, для этого в etc/netplan/00-installer-config.yaml надо добавить строки: macaddress: 10:10:10:10:10:BA, dhcp4: true .

![Alt text](screenshots/6_6.png)

- Так же добавлю MAC в VirtualBox

![Alt text](screenshots/6_7.png)

- Для r1 настроить аналогично r2, но сделать выдачу адресов с жесткой привязкой к MAC-адресу (ws11). Провести аналогичные тесты .

![Alt text](screenshots/6_8.png)

- Аналогично пропишу в файле resolv.conf 8.8.8.8.

![Alt text](screenshots/6_9.png)

- Перезагружу службу DHCP .

![Alt text](screenshots/6_10.png)

- После перезагрузки ws11 увидим что появился ip адрес

![Alt text](screenshots/6_11.png)

- Запросить с ws21 обновление ip адреса

- До обновления

![Alt text](screenshots/6_12.png)

- С помощью команды dhclient -r удалим ip адреса для сетевого интерфейса

![Alt text](screenshots/6_13.png)

- И с помощью команды dhclient обновим

- После обновления 

![Alt text](screenshots/6_14.png)

- Я пользовался опциями dhclient -r для удаления и dhclient для добавления ip.

- Сохраню дампы .

## Part 7. NAT

- В файле /etc/apache2/ports.conf на ws22 и r1 изменить строку Listen 80 на Listen 0.0.0.0:80, то есть сделать сервер Apache2 общедоступным

- ws22

![Alt text](screenshots/7_1.png)

- r1

![Alt text](screenshots/7_2.png)

- Запустить веб-сервер Apache командой service apache2 start на ws22 и r1

- ws22

![Alt text](screenshots/7_3.png)

- r1

![Alt text](screenshots/7_4.png)

- Добавить в фаервол, созданный по аналогии с фаерволом из Части 4, на r2 следующие правила:

1) удаление правил в таблице filter - iptables -F


2) удаление правил в таблице "NAT" - iptables -F -t nat


3) отбрасывать все маршрутизируемые пакеты - iptables --policy FORWARD DROP

![Alt text](screenshots/7_5.png)

- Запустить файл также, как в Части 4.

![Alt text](screenshots/7_6.png)

- Проверить соединение между ws22 и r1 командой ping.

- При запуске файла с этими правилами, ws22 не должна "пинговаться" с r1 .

![Alt text](screenshots/7_7.png)

- Добавить в файл ещё одно правило:

4) разрешить маршрутизацию всех пакетов протокола ICMP.

![Alt text](screenshots/7_8.png)

- Запустить файл.

![Alt text](screenshots/7_9.png)

- Проверить соединение между ws22 и r1 командой ping.

- При запуске файла с этими правилами, ws22 должна "пинговаться" с r1.

![Alt text](screenshots/7_10.png)

5) включить SNAT, а именно маскирование всех локальных ip из локальной сети, находящейся за r2 (по обозначениям из Части 5 - сеть 10.20.0.0)
Совет: стоит подумать о маршрутизации внутренних пакетов, а также внешних пакетов с установленным соединением

6) включить DNAT на 8080 порт машины r2 и добавить к веб-серверу Apache, запущенному на ws22, доступ извне сети

![Alt text](screenshots/7_11.png)

- Проверить соединение по TCP для DNAT, для этого с r1 подключиться к серверу Apache на ws22 командой telnet (обращаться по адресу r2 и порту 8080).

![Alt text](screenshots/7_12.png)

- Сохраню дампы .

## Part 8. Дополнительно. Знакомство с SSH Tunnels

- Запустить на r2 фаервол с правилами из Части 7 .

![Alt text](screenshots/8_1.png)

- Запустить веб-сервер Apache на ws22 только на localhost (то есть в файле /etc/apache2/ports.conf изменить строку Listen 80 на Listen localhost:80)

![Alt text](screenshots/8_2.png)

- Воспользоваться Local TCP forwarding с ws21 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws21

![Alt text](screenshots/8_3.png)

- Для проверки, сработало ли подключение в обоих предыдущих пунктах, перейдите во второй терминал (например, клавишами Alt + F2) и выполните команду:

![Alt text](screenshots/8_4.png)

- Воспользоваться Remote TCP forwarding c ws11 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws11

![Alt text](screenshots/8_5.png)

- Сделаю еще одну проверку на подключение

![Alt text](screenshots/8_6.png)

- Для подключения с ws21 до ws22 я использовал ssh -L 8080:localhost:80 aquaneli@10.20.0.20 .

- ssh -L используется для создания локального проброса портов (Local Port Forwarding). В данном случае я сделал проброс 8080 на удаленный порт 80 на хосте с адресом 10.20.0.20 .

- Для подключения на ws22 с ws11 я использовал ssh -R 8079:localhost:80 aquaneli@10.10.0.2 . (Remote Port Forwarding)

- ssh -R установит обратный туннель с ws11 на ws22, перенаправляя трафик с порта 8079 на порт 80 (localhost). То есть я сам себе даю доступ на другой машине, самому себе.
 
- Сохраню дампы машин .